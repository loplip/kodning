name: scrape-daily

on:
  schedule:
    # 05:00 UTC ≈ 06:00 (sommar) / 07:00 (vinter) i Sverige
    - cron: "0 5 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-scripts:
    runs-on: ubuntu-latest

    steps:
      - name: Check out
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Python (with pip cache)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: pw-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            pw-${{ runner.os }}-

      - name: Install dependencies
        run: |
          python -m pip install -r requirements.txt
          python -m playwright install chromium
          # INTE: python -m playwright install-deps

      - name: Run all scripts (module mode; never stop on error)
        run: |
          set +e
          declare -A rc

          echo " "
          python -u -m scripts.eql_find; rc[eql_find]=$?

          echo " "
          python -u -m scripts.adtraction_stats; rc[adtraction_stats]=$?

          echo " "
          python -u -m scripts.adtraction_epc_finance; rc[adtraction_epc_finance]=$?

          echo " "
          python -u -m scripts.rugvista_aov; rc[rugvista_aov]=$?

          echo " "
          python -u -m scripts.soder_stats; rc[soder_stats]=$?

          echo " "
          python -u -m scripts.fractal_refine; rc[fractal_refine]=$?

          echo " "
          python -u -m scripts.fractal_scape; rc[fractal_scape]=$?

          {
            echo "## Daglig scraping – summering"
            echo ""
            echo "| Script | Status |"
            echo "|-------:|:-------|"
            for k in "${!rc[@]}"; do
              if [ "${rc[$k]}" -eq 0 ]; then st="✅ OK"; else st="❌ FAIL (${rc[$k]})"; fi
              echo "| \`$k\` | $st |"
            done
          } >> "$GITHUB_STEP_SUMMARY"

          exit 0

      - name: Backup updated XLSX files to history
        if: always()
        run: |
          mkdir -p history
          TODAY=$(date +%Y-%m-%d)
          MODIFIED=$(git diff --name-only HEAD -- data/*.xlsx || true)
          NEW=$(git ls-files --others --exclude-standard -- data/*.xlsx || true)
          for f in $MODIFIED $NEW; do
            [ -f "$f" ] || continue
            base=$(basename "$f")
            dest="history/backup_${TODAY}_$base"
            cp "$f" "$dest"
            echo "Backup: $f -> $dest"
          done

      - name: Commit & push updated files (if any)
        if: always()
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/*.xlsx || true
          git add history/backup_*.xlsx || true
          if git diff --cached --quiet; then
            echo "Inga ändringar att committa."
            exit 0
          fi
          git commit -m "chore: update data files + selective backups [skip ci]"
          git push origin HEAD:${GITHUB_REF_NAME:-main}
